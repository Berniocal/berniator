<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="theme-color" content="#0b1323" />
<title>Berni√°tor ‚Äî gener√°tor 1 periody</title>

<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./assets/icons/icon-192.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="./assets/icons/apple-touch-180.png">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="Berni√°tor" />
<meta name="description" content="Nakresli 1 periodu v m≈ô√≠≈æce a p≈ôehraj ji jako zvuk ‚Äî offline PWA.">

<style>
  :root{
    --bg:#0b1323; --bg2:#0f1722; --panel:#101826; --accent:#60a5fa;
    --text:#e6eef8; --muted:#9fb0c7; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --r:16px; --gap:12px;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color: transparent;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font:16px/1.35 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .app{min-height:100dvh;display:flex;flex-direction:column;gap:12px;padding:12px;padding-top:env(safe-area-inset-top);padding-bottom:calc(env(safe-area-inset-bottom) + 12px)}
  h1{font-size:18px;margin:2px 0 0 0;text-align:center}
  .hint{margin:0;color:var(--muted);font-size:.9rem;text-align:center}
  .pad-wrap{position:relative;flex:1 1 auto;border-radius:16px;overflow:hidden;background:#0b1220;box-shadow:0 8px 28px rgba(0,0,0,.35)}
  .pad-wrap #pad{width:100%;height:58vh;display:block;touch-action:none}
  .toolbar{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;background:transparent;margin-top:8px}
  @media (min-width:740px){ .toolbar{grid-template-columns:repeat(6,1fr)} }
  button, .btn{
    appearance:none;border:0;border-radius:14px;background:#152236;color:var(--text);
    padding:14px 12px;font-weight:600;font-size:16px;min-height:48px;box-shadow:0 2px 0 rgba(0,0,0,.35);
  }
  button:active{transform:translateY(1px)}
  .ok{background:var(--ok);color:#05150a}
  .danger{background:var(--danger);color:#1a0a0a}
  .chipbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{padding:10px 12px;border-radius:999px;background:#0b1220;border:1px solid #1e293b;color:var(--muted);font-size:.9rem}
  .chip.active{background:#1e344f;color:#cfe6ff;border-color:#335d91}
  .panel{background:var(--panel);border-radius:16px;padding:12px;box-shadow:0 8px 28px rgba(0,0,0,.35)}
  label{display:block;font-size:.85rem;color:var(--muted);margin-bottom:4px}
  input[type="number"], input[type="text"]{
    width:100%;padding:12px;border-radius:12px;border:1px solid #1f334a;background:#0b1220;color:var(--text);font-size:16px;
  }
  input[type="range"]{width:100%;height:36px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .install{display:none; margin-top:8px}
  .footer-note{font-size:.85rem;color:var(--muted);text-align:center;margin-top:8px}
</style>
</head>
<body>
  <div class="app">
    <div>
      <h1>Nakresli 1 periodu ‚Üí p≈ôehraj üéß</h1>
      <p class="hint">Kresli prstem do m≈ô√≠≈æky. Vyber p≈ôedvolbu nebo vlastn√≠ tvar. Nastav frekvenci a dej <b>P≈ôehr√°t</b>. Funguje i offline.</p>
    </div>

    <div class="pad-wrap" aria-label="Kresl√≠c√≠ plocha periody">
      <canvas id="pad"></canvas>
    </div>

    <div class="panel">
      <div class="toolbar" role="toolbar" aria-label="Kreslen√≠">
        <button id="btnDraw" class="chip active" aria-pressed="true">‚úèÔ∏è Kreslit</button>
        <button id="btnErase" class="chip" aria-pressed="false">ü©π Vyhladit</button>
        <button id="btnClear" class="chip">üóëÔ∏è Vymazat</button>
        <button id="btnNormalize" class="chip">‚ÜîÔ∏è Normalizovat</button>
        <button id="btnCenter" class="chip">‚öñÔ∏è Bez DC</button>
        <button id="btnInvert" class="chip">‚áÖ Invertovat</button>
      </div>

      <div class="chipbar" id="presets" role="group" aria-label="P≈ôedvolby">
        <div class="chip active" data-preset="sine">Sinus</div>
        <div class="chip" data-preset="square">ƒåtverec</div>
        <div class="chip" data-preset="saw">Pila</div>
        <div class="chip" data-preset="triangle">Troj√∫heln√≠k</div>
        <div class="chip" id="btnHalfRect">P≈Ølvlnn√Ω usmƒõrnƒõn√Ω</div>
      </div>

      <div class="two" style="margin-top:8px">
        <div>
          <label for="freq">Frekvence (Hz)</label>
          <input id="freq" type="number" min="1" max="20000" step="0.1" value="440" inputmode="decimal">
        </div>
        <div>
          <label for="period">Perioda (ms)</label>
          <input id="period" type="number" min="0.05" max="1000" step="0.01" value="2.2727" inputmode="decimal">
        </div>
      </div>
      <input id="freqSlider" type="range" min="10" max="20000" step="1" value="440" style="margin-top:8px" aria-label="Posuvn√≠k frekvence">

      <div class="two" style="margin-top:8px">
        <button id="btnPlay" class="ok">‚ñ∂Ô∏è P≈ôehr√°t</button>
        <button id="btnStop" class="danger">‚èπÔ∏è Stop</button>
      </div>

      <div class="install">
        <button id="btnInstall" class="accent">‚ûï Nainstalovat Berni√°tor</button>
      </div>

      <p class="footer-note">Berni√°tor ‚Ä¢ funguje offline ‚Ä¢ ≈æ√°dn√© trackery</p>
    </div>
  </div>

<script>
(() => {
  // ----------- PWA: registrace service workeru + install tlaƒç√≠tko -----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js');
      if ('navigationPreload' in navigator.serviceWorker) {
        navigator.serviceWorker.ready.then(reg => reg.navigationPreload?.enable());
      }
    });
  }
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.querySelector('.install').style.display = 'block';
  });
  document.getElementById('btnInstall')?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    document.querySelector('.install').style.display = 'none';
  });

  // ------------------- APLIKACE: kreslen√≠ + audio gener√°tor -------------------
  const TABLE_SIZE = 1024;
  const DRAW_SMOOTH = 0.35;
  let table = new Float32Array(TABLE_SIZE);
  let tool = 'draw';
  let needRedraw = true;

  let ctxAudio = null, node = null, usingWorklet = false, osc = null, gain = null;

  const pad = document.getElementById('pad');
  let ctx = pad.getContext('2d') || pad.getContext('2d', { alpha: false });

  function ensureCanvasSize(){
    const cssW = pad.clientWidth || window.innerWidth;
    const cssH = pad.clientHeight || Math.floor(window.innerHeight * 0.58);
    const ratio = Math.min(window.devicePixelRatio||1, 2);
    const w = Math.max(10, Math.floor(cssW*ratio));
    const h = Math.max(10, Math.floor(cssH*ratio));
    if (pad.width !== w || pad.height !== h){
      pad.width = w; pad.height = h;
      needRedraw = true;
    }
  }

  function setPreset(name){
    for(let i=0;i<TABLE_SIZE;i++){
      const t = i/TABLE_SIZE;
      if(name==='sine') table[i] = Math.sin(2*Math.PI*t);
      else if(name==='square') table[i] = Math.sign(Math.sin(2*Math.PI*t)) || 1;
      else if(name==='saw') table[i] = 2*(t - Math.floor(t+0.5));
      else if(name==='triangle') table[i] = 1 - 4*Math.abs(Math.round(t-0.25)-(t-0.25));
    }
    removeDC(); requestDraw(); sendTableToAudio();
    document.querySelectorAll('#presets .chip').forEach(c=>c.classList.remove('active'));
    const btn = document.querySelector(`#presets .chip[data-preset="${name}"]`);
    if(btn) btn.classList.add('active');
  }
  function removeDC(){ let s=0; for(let i=0;i<table.length;i++) s+=table[i]; const m=s/table.length; for(let i=0;i<table.length;i++) table[i]-=m; }
  function normalize(){ let m=0; for(let i=0;i<table.length;i++) m=Math.max(m,Math.abs(table[i])); if(m>1e-9){ const k=1/m; for(let i=0;i<table.length;i++) table[i]*=k; } }
  setPreset('sine');

  let drawing=false,lastX=0;
  function xyToIdxVal(x,y){
    const rect = pad.getBoundingClientRect();
    const rx = (x - (rect.left||0)) / (rect.width||pad.clientWidth||1);
    const ry = (y - (rect.top||0))  / (rect.height||pad.clientHeight||1);
    const idx = Math.min(TABLE_SIZE-1, Math.max(0, Math.floor(rx*TABLE_SIZE)));
    const val = Math.min(1, Math.max(-1, (1 - 2*ry)));
    return {idx, val};
  }
  function pointerDown(ev){
    drawing = true;
    const p = ev.touches ? ev.touches[0] : ev;
    const {idx,val} = xyToIdxVal(p.clientX, p.clientY);
    lastX = idx; applyTool(idx,val); requestDraw();
  }
  function pointerMove(ev){
    if(!drawing) return;
    const p = ev.touches ? ev.touches[0] : ev;
    const {idx,val} = xyToIdxVal(p.clientX, p.clientY);
    const i0 = Math.min(lastX, idx), i1 = Math.max(lastX, idx);
    for(let i=i0;i<=i1;i++){
      const a = (i1===i0)?1:(i-i0)/(i1-i0);
      const v = table[lastX]*(1-a) + val*a;
      applyTool(i, v);
    }
    lastX = idx; requestDraw();
  }
  function pointerUp(){ drawing=false; sendTableToAudio(); }
  function applyTool(i,v){ if(tool==='draw') table[i]=v; else table[i]=table[i]*(1-DRAW_SMOOTH); }

  pad.addEventListener('mousedown', pointerDown);
  pad.addEventListener('mousemove', pointerMove);
  window.addEventListener('mouseup', pointerUp);
  pad.addEventListener('touchstart', e=>{ e.preventDefault(); pointerDown(e); }, {passive:false});
  pad.addEventListener('touchmove',  e=>{ e.preventDefault(); pointerMove(e); }, {passive:false});
  pad.addEventListener('touchend',   e=>{ e.preventDefault(); pointerUp(e); }, {passive:false});

  function requestDraw(){ needRedraw = true; }
  function drawNow(){
    if (!needRedraw || !ctx) return;
    ensureCanvasSize();
    needRedraw = false;
    const w = pad.width, h = pad.height;
    const ratio = Math.min(window.devicePixelRatio||1, 2);

    ctx.clearRect(0,0,w,h);
    ctx.save();
    // grid
    ctx.strokeStyle='#1e293b'; ctx.lineWidth = 1*ratio;
    ctx.beginPath();
    for(let k=0;k<=8;k++){ const x=(w/8)*k; ctx.moveTo(x,0); ctx.lineTo(x,h); }
    for(let k=0;k<=8;k++){ const y=(h/8)*k; ctx.moveTo(0,y); ctx.lineTo(w,y); }
    ctx.stroke();
    // axis
    ctx.strokeStyle='#335d91';
    ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
    // curve
    ctx.strokeStyle='#60a5fa'; ctx.lineWidth = 2*ratio;
    ctx.beginPath();
    for(let i=0;i<TABLE_SIZE;i++){
      const x = i/(TABLE_SIZE-1)*w;
      const y = (1 - (table[i]+1)/2)*h;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.restore();
  }
  function raf(){ drawNow(); requestAnimationFrame(raf); }
  window.addEventListener('resize', ()=>{ ensureCanvasSize(); requestDraw(); });

  // toolbar
  document.getElementById('btnDraw').onclick = ()=>{ tool='draw'; document.getElementById('btnDraw').classList.add('active'); document.getElementById('btnErase').classList.remove('active'); };
  document.getElementById('btnErase').onclick= ()=>{ tool='erase'; document.getElementById('btnErase').classList.add('active'); document.getElementById('btnDraw').classList.remove('active'); };
  document.getElementById('btnClear').onclick= ()=>{ table.fill(0); requestDraw(); sendTableToAudio(); };
  document.getElementById('btnNormalize').onclick= ()=>{ normalize(); requestDraw(); sendTableToAudio(); };
  document.getElementById('btnCenter').onclick= ()=>{ removeDC(); requestDraw(); sendTableToAudio(); };
  document.getElementById('btnInvert').onclick= ()=>{ for(let i=0;i<table.length;i++) table[i]=-table[i]; requestDraw(); sendTableToAudio(); };

  document.getElementById('presets').addEventListener('click',(e)=>{
    const el=e.target.closest('.chip[data-preset]'); if(!el) return; setPreset(el.dataset.preset);
  });
  document.getElementById('btnHalfRect').onclick= ()=>{ for(let i=0;i<table.length;i++) table[i]=Math.max(0,table[i])*2 - 1; removeDC(); normalize(); requestDraw(); sendTableToAudio(); };

  // freq/period
  const elF=document.getElementById('freq'), elP=document.getElementById('period'), elS=document.getElementById('freqSlider');
  function setFreq(f){ f=Math.max(1,Math.min(20000,+f||0)); elF.value=(Math.round(f*100)/100).toString(); elP.value=(1000/f).toFixed(4); elS.value=Math.max(20,Math.min(5000,f)); setFrequencyParam(f); }
  function setPer(ms){ ms=Math.max(0.05,Math.min(1000,+ms||0)); elP.value=ms.toFixed(4); const f=1000/ms; elF.value=f.toFixed(2); elS.value=Math.max(20,Math.min(5000,f)); setFrequencyParam(f); }
  elF.addEventListener('input', e=>setFreq(e.target.value));
  elP.addEventListener('input', e=>setPer(e.target.value));
  elS.addEventListener('input', e=>setFreq(e.target.value));
  setFreq(440);

  // audio: worklet + fallback
  async function ensureAudio(){
    if(ctxAudio) return;
    ctxAudio=new (window.AudioContext||window.webkitAudioContext)();
    try{
      const code=`class WavePlayer extends AudioWorkletProcessor{static get parameterDescriptors(){return[{name:'frequency',defaultValue:440,minValue:0,maxValue:20000}]}
      constructor(){super();this.table=new Float32Array([0,1,0,-1]);this.phase=0;this.port.onmessage=e=>{if(e.data&&e.data.type==='setTable'){this.table=new Float32Array(e.data.table);this.phase=0}}}
      process(i,o,p){const out=o[0][0],freq=p.frequency,N=this.table.length;for(let j=0;j<out.length;j++){const f=freq.length>1?freq[j]:freq[0];const step=f*N/sampleRate;this.phase+=step;if(this.phase>=N)this.phase-=Math.floor(this.phase/N)*N;const i0=Math.floor(this.phase),i1=(i0+1)%N,frac=this.phase-i0;out[j]=this.table[i0]*(1-frac)+this.table[i1]*frac}return true}}registerProcessor('wave-player',WavePlayer);`;
      const blob=new Blob([code],{type:'application/javascript'}); const url=URL.createObjectURL(blob);
      await ctxAudio.audioWorklet.addModule(url);
      node=new AudioWorkletNode(ctxAudio,'wave-player',{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[1],parameterData:{frequency:440}});
      node.connect(ctxAudio.destination); usingWorklet=true; sendTableToAudio();
    }catch(e){
      gain=ctxAudio.createGain(); gain.connect(ctxAudio.destination);
      makeOrUpdateOscillator(); usingWorklet=false;
    }
  }
  function sendTableToAudio(){
    if(!ctxAudio) return;
    const tmp=new Float32Array(table.length); let s=0; for(let i=0;i<table.length;i++) s+=table[i];
    const m=s/table.length; let mx=0; for(let i=0;i<table.length;i++){ tmp[i]=table[i]-m; mx=Math.max(mx,Math.abs(tmp[i])); }
    const k=mx>1?1/mx:1; for(let i=0;i<table.length;i++) tmp[i]*=k;
    if(usingWorklet){ node.port.postMessage({type:'setTable',table:tmp}); } else { makeOrUpdateOscillator(tmp); }
  }
  function setFrequencyParam(f){
    if(!ctxAudio) return;
    if(usingWorklet&&node){ node.parameters.get('frequency').setValueAtTime(f,ctxAudio.currentTime); }
    else if(osc){ osc.frequency.setValueAtTime(f,ctxAudio.currentTime); }
  }
  function makeOrUpdateOscillator(waveTable){
    if(osc){ try{osc.stop();}catch{} osc.disconnect(); osc=null; }
    osc=ctxAudio.createOscillator(); osc.frequency.value=+document.getElementById('freq').value||440;
    if(waveTable){
      const N=waveTable.length,K=64,real=new Float32Array(K+1),imag=new Float32Array(K+1);
      for(let k=1;k<=K;k++){ let a=0,b=0; for(let n=0;n<N;n++){ const ph=2*Math.PI*k*n/N; a+=waveTable[n]*Math.cos(ph); b+=waveTable[n]*Math.sin(ph); } real[k]=(2/N)*a; imag[k]=(2/N)*(-b); }
      const pw=ctxAudio.createPeriodicWave(real,imag,{disableNormalization:false}); osc.setPeriodicWave(pw);
    } else { osc.type='sine'; }
    osc.connect(gain); osc.start();
  }

  document.getElementById('btnPlay').onclick = async ()=>{ await ensureAudio(); if(ctxAudio.state!=='running') await ctxAudio.resume(); };
  document.getElementById('btnStop').onclick = async ()=>{ if(ctxAudio){ await ctxAudio.suspend(); } };

  // initial sizing & paint
  ensureCanvasSize(); requestDraw();
  (function loop(){ drawNow(); requestAnimationFrame(loop); })();
})();
</script>
</body>
</html>
